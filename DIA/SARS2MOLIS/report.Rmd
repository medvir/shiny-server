---
title: ""
output: pdf_document
params:
  end_time: NA
  cycler_nr: NA
  plot: NA
  raw_data: NA
  molis_out_table: NA
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
```

```{r instrument}
# convert cycler_nr to cycler_type (both vectors have to be in the same order)
cycler_nr <- c("278870036", "278870051", "278880633", "278880634")
cycler_type <- c("QS7-rechts", "QS7-links", "ViiA-7-rechts", "ViiA-7-links")

cycler_i <- match(params$cycler_nr, cycler_nr)
```

Experiment Run End Time: `r params$end_time`  
Instrument: `r cycler_type[cycler_i]` (`r params$cycler_nr`)

```{r table}
# leaves cells with NA blank instead of printing NA
options(knitr.kable.NA = "")

knitr::kable(params$molis_out_table)
```

\newpage


```{r plot, fig.height = 11, fig.width = 8}
params$plot
```

\newpage

```{r plate_layout, fig.width = 8}
params$raw_data %>%
  group_by(sample_name, target) %>%
  sample_n(1) %>%
  ungroup() %>%
  filter(target != "MS-2") %>%
  mutate(target = ifelse(target == "GAPDH", paste0(target, " / MS-2"), target),
         # if the full molis nr. was entered, only the 6 last letters are extracted
         sample_name = if_else(str_detect(sample_name, "1000"), str_sub(sample_name, -6), sample_name),
         row = str_sub(well_pos, 1, 1),
         row = fct_relevel(row, c("H", "G", "F", "E", "D", "C", "B", "A")),
         column = as.numeric(str_sub(well_pos, 2))) %>%
  ggplot(aes(x = row, y = column, label = sample_name, color = target)) +
  geom_text() +
  coord_flip() +
  #scale_color_manual(values = c("#E69F00", "#009E73")) +
  scale_y_continuous(limits = c(1, 12), breaks = c(1:12), minor_breaks = NULL) +
  theme_light() +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL)

```

------

```{r plate_ct, fig.width = 8}
params$raw_data %>%
  group_by(sample_name, target) %>%
  sample_n(1) %>%
  ungroup() %>%
  mutate(row = str_sub(well_pos, 1, 1),
         row = fct_relevel(row, c("H", "G", "F", "E", "D", "C", "B", "A")),
         column = as.numeric(str_sub(well_pos, 2))) %>%
  ggplot(aes(x = row, y = column, shape = target)) +
  geom_point(aes(fill = as.numeric(ct_export)), size = 4) +
  coord_flip() +
  scale_y_continuous(limits = c(1, 12), breaks = c(1:12), minor_breaks = NULL) +
  scale_shape_manual(values = c(21, 24, 25)) +
  scale_fill_gradient(low = "brown3", high = "white", na.value = "grey", limits = c(NA, 45)) +
  theme_light() +
  theme(legend.position = "top",
        legend.title = element_blank()) +
  labs(x = NULL, y = NULL)

```
